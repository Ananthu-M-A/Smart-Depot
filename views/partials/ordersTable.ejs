<div class="container">
  <div class="row">
    <div class="col-md">
      <table class="table text-center" id="admin-table">
        <thead>
          <tr>
            <th scope="col">Order Id</th>
            <th scope="col">Items</th>
            <th scope="col">Amount</th>
            <th scope="col">Method</th>
            <th scope="col">Status</th>
          </tr>
        </thead>
        <tbody>
          <% orders.forEach(order=> { %>  
            <tr>
              <td class="align-middle">
                <h5><%= order._id %>
                  <button class="btn-icon">
                  <img src="/images/details.png" style="width: 3vh;" alt=""></button>
                </h5>
                <p><%= order.orderDate %></p>
              </td>
              <td class="align-middle">
                <%= order.products.length %>
              </td>
              <td class="align-middle">
                <%= order.total %>
              </td>
              <td class="align-middle">
                <%= order.paymentMethod %>
              </td>
              <td class="align-middle">
                <div>
                    <div>
                      <select class="custom-select text-center" id="orderStatus_<%= order._id %>" onchange="updateOrderStatus('<%= order._id %>')">
                        <option value="Order Initiated" <%= order.orderStatus === "Order Initiated" ? "selected" : "" %>>Order Initiated</option>
                        <option value="Order Confirmed" <%= order.orderStatus === "Order Confirmed" ? "selected" : "" %>>Order Confirmed</option>
                        <option value="Order Cancelled" <%= order.orderStatus === "Order Cancelled" ? "selected" : "" %>>Order Cancelled</option>
                        <option value="Items Shipped" <%= order.orderStatus === "Items Shipped" ? "selected" : "" %>>Items Shipped</option>
                        <option value="Order Delivered" <%= order.orderStatus === "Order Delivered" ? "selected" : "" %>>Order Delivered</option>
                        <option value="Return Initiated" <%= order.orderStatus === "Return Initiated" ? "selected" : "" %>>Return Initiated</option>
                        <option value="Items Returned" <%= order.orderStatus === "Items Returned" ? "selected" : "" %>>Items Returned</option>
                        <option value="Items Closed" <%= order.orderStatus === "Items Closed" ? "selected" : "" %>>Order Closed</option>
                      </select>
                    </div>
                  
              </div>
            </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  async function updateOrderStatus(id) {
    const orderStatusUpdate = document.getElementById(`orderStatus_${id}`);

    if (confirm(`Are you sure you want to make changes in order status of the user?`)) {
      const userData = {
        orderId: id,
        orderStatus: orderStatusUpdate.value,
      };
  
      try {
        const response = await fetch(`/adminHome/updateOrderStatus`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(userData),
        });

        if (response.ok) {
          console.log('Order status updated successfully');
        } else {
          console.error('Failed to update order status');
          alert('Failed to update order status. Please try again.');
        }
      } catch (error) {
        console.error('Error updating order:', error);
        alert('An error occurred while updating the order status.');
      }
    }
  }
</script>
